@section otherstyle{<link />    }

<h3>用户管理</h3>
<!--查询-->
<div class="row">
    <div class="navbar-form navbar-left">
        <div class="form-group">
            <input type="text" id="input-search" class="form-control" placeholder="搜索用户名">
            <button type="button" id="btn-search" class="btn btn-default">搜索</button>
            <button type="button" id="btn-empty" class="btn btn-default">清空</button>
        </div>
    </div>
</div>
<!--查询-->
<!--表格-->
<h2 class="sub-header">
    <button id="btnAddUser" style="margin: 10px 0;" data-toggle="modal" data-target="#myModal" class="btn btn-default">添加用户</button>
</h2>
<div class="table-responsive">
    <table class="table table-bordered text-nowrap">
        <thead>
            <tr>
                <th>编号</th>
                <th>用户名称</th>
                <th>角色名称</th>
                <th>登陆账户</th>
                <th>登陆密码</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="list-tbody"></tbody>
    </table>
</div>
<!--表格-->
<!---分页 start-->
<div class="row">
    <div class="col-md-4 col-md-offset-8">
        <nav aria-label="Page navigation">
            <ul id="pagination" class="pagination"></ul>
        </nav>
    </div>
</div>
<!---分页 end-->
<!-- Modal start -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">添加用户</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="name">用户名称</label>
                        <input type="text" id="name" class="form-control" placeholder="用户名称">
                    </div>
                    <div class="form-group">
                        <label for="username">登陆用户名</label>
                        <input type="text" id="username" class="form-control" placeholder="登陆用户名">
                    </div>
                    <div class="form-group">
                        <label for="password">登陆密码</label>
                        <input type="text" id="password" class="form-control" placeholder="登陆密码">
                    </div>
                    <div class="form-group">
                        <label for="roleid">设置角色</label>
                        <select id="roleid" class="form-control">
                            
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary">提交</button>
            </div>
        </div>
    </div>
</div>
<script>

    //存储列表数据
    var $userList = [];

    //被选中的信息id
    var id;

    //存储选择框中的项
    var option = -1;

    //存储搜索内容
    var value = "";

    var Index = 0;

    //[] 启动模态框按钮
    $("#btnAddUser").click(function () {
        $(".modal .modal-footer .btn-primary").text("提交");
    })

    //[search] 清空按钮
    $("#btn-empty").click(function () {
        $("#input-search").val('');
    })

    //[modal] 添加客户ajax||修改客户的ajax
    $(".modal .modal-footer .btn-primary").click(function () {

        if ($(this).text() == "提交") {
            userAdd();
        } else {
            userUpdate();
        }

    })


    //[table] 修改按钮  模态框出现
    $("#list-tbody").on("click", ".btn-success", function () {
        id = $(this).attr("data-id");
        userInfo();
    })

    //[table] 删除按钮  确定框出现
    $("#list-tbody").on("click", ".btn-danger", function () {
        id = $(this).attr("data-id");
        if (confirm("您确定要删除吗？")) {
            userDelete();
        }
        return false;
    })

    //[pagination] 分页按钮 获取数据
    $("#pagination").on("click", "li", function () {
        if (Index = $(this).attr("data-pageIndex")) return;
        Index = $(this).attr("data-pageIndex");
        userSearch($(this).attr("data-pageIndex"));
    })

    //[navbar] 搜索按钮
    $("#btn-search").click(function () {
        //赋值给全局
        value = $("#input-search").val();
        console.log(value);
        option = 0;
        userSearch(Index);
    })




    

    //[table]  渲染表格客户信息
    function listRendering() {
        var listTemplate;
        //清空数据
        $(".table-responsive tbody").html('');

        //判断表格是否用数据
        if ($userList.length == 0) {
            listTemplate = `<tr>
        <td style="text-align:center;line-height:100px" colspan="7">没有数据</td>
        </tr>`;
            $(".table-responsive tbody").append(listTemplate);
            return;
        }

        console.log($userList);
        $.each($userList, function (index, data) {
            console.log(1);
            listTemplate = `<tr>
            <td>${data.id}</td>
            <td>${data.name}</td>
             <td>${data.rolename ? data.rolename:""}</td>   
            <td>${data.username}</td>
            <td>${data.password}</td>
            <td>${new Date(parseInt(data.usertime.substr(6, 13))).toLocaleDateString()}</td>
            <td>
                <a data-id=${data.id} class="btn btn-danger btn-xs">删除</a>
                <a data-id=${data.id} class="btn btn-success btn-xs">修改</a>
            </td>
        </tr>`;
            $(".table-responsive tbody").append(listTemplate);
        })

    }

    //[pagination] 分页渲染
    function pagination(pageIndex, pageCount) {
        $(".pagination").html('');
        if (pageCount == 1) {
            $(".pagination").append(``);
            return;
        }
        var start = pageIndex - 2;//计算起始位置，要求页面上显示4个数字页 1~5
        if (start < 1) {
            start = 1;
        }
        var end = start + 3;

        if (end > pageCount) {
            end = pageCount;
            start = end - 3 < 1 ? 1 : end - 3;
        }

        if (pageIndex > 1) {
            console.log("执行");
            $(".pagination").append(`<li data-pageIndex=${pageIndex - 1}><a   aria-label="Previous"><span aria-hidden="true">&laquo;</span>
            </a></li>`);
        }
        //循环遍历页数
        for (var i = start; i <= end; i++) {
            if (i == pageIndex) {
                //当前页
                $(".pagination").append(`<li class="active" data-pageIndex=${i}><a >${i}</a></li>`);
            }
            else {
                $(".pagination").append(`<li data-pageIndex=${i}><a >${i}</a></li>`);


            }
        }
        if (pageIndex < pageCount) {
            $(".pagination").append(`<li data-pageIndex=${pageIndex + 1}><a aria-label="Next"><span aria-hidden="true">&raquo;</span>
            </a></li>`);
        }
    }

    //[ajax] /user/Add 客户添加
    function userAdd() {
        $.ajax({
            type: "POST",
            url: "http://localhost:60440/User/Add",
            dataType: "json",
            data: {
                username: $("#username").val(),
                name: $("#name").val(),
                password: $("#password").val(),
            },
            success: function (res) {

                //打印返回结果
                console.log(res);

                if (res.state == 0) {
                    showTips(res.info, 50, 2, "#e74c3c");
                    return
                }
                //关闭模态框
                $('#myModal').modal('hide');
                showTips(res.info, 50, 2, "#8FBC8F");

                //刷新列表
                setTimeout(function () {
                    userSearch(Index);
                }, 2000)

            },
            error: function (error) {
                console.log(error);
            }
        });
    }

    //[ajax] /user/Delete 客户删除
    function userDelete() {
        $.ajax({
            type: "POST",
            url: "http://localhost:60440/user/Delete",
            dataType: "json",
            data: { id },
            success: function (res) {
                //打印返回结果
                console.log(res);

                //状态判断
                if (res.state == 0) {
                    showTips(res.info, 50, 2, "#e74c3c");
                    return
                }

                //成功的
                showTips(res.info, 50, 2, "#8FBC8F");


                //刷新列表
                setTimeout(function () {
                    userSearch(Index);
                }, 2000)

            },
            error: function (error) {
                console.log(error);
            }
        });
    }

    //[ajax] /user/Update 客户修改
    function userUpdate() {
        $.ajax({
            type: "POST",
            url: "http://localhost:60440/user/Update",
            dataType: "json",
            data: {
                id,
                username: $("#username").val(),
                name: $("#name").val(),
                password: $("#password").val(),
                roleid: $("#roleid option:selected").val()
            },
            success: function (res) {

                //打印返回结果
                console.log(res);

                if (res.state == 0) {
                    showTips(res.info, 50, 2, "#e74c3c");
                    return
                }

                //关闭模态框
                $('#myModal').modal('hide');
                showTips(res.info, 50, 2, "#8FBC8F");
                $('.btn-primary').text("提交");

                //刷新列表
                setTimeout(function () {
                    userSearch(Index);
                }, 2000);
            },
            error: function (error) {
                console.log(error);
            }
        });
    }

    //[ajax] /user/Search 客户搜索
    function userSearch(pageIndex) {
        $.ajax({
            type: "POST",
            url: "http://localhost:60440/user/Search",
            dataType: "json",
            data: { value, pageIndex, option },
            success: function (res) {
                //打印返回结果
                console.log(res);
                var list = res.list;
                var pageIndex = res.pageIndex;
                var pageCount = res.pageCount;
                if (list.length > 0) {
                    showTips("表格已刷新", 50, 2, "#8FBC8F");
                } else {
                    showTips("没有查询到数据", 50, 2, "#e74c3c");
                }
                $userList = list;
                //列表渲染
                listRendering();
                pagination(pageIndex, pageCount);


            },
            error: function (error) {
                console.log(error);
            }
        })
    }

    //[ajax] user/Info 客户个人信息
    function userInfo() {
        $.ajax({
            type: "GET",
            url: "http://localhost:60440/User/Info",
            dataType: "json",
            data: { id },
            success: function (res) {

                //打印返回结果
                console.log(res);

                //初始化模态框中的数据
                $("#username").val(res.username),
                $("#name").val(res.name),
                $("#password").val(res.password),

                //显示模态框
                $('#myModal').modal('show');
                $('.btn-primary').text("修改");
            },
            error: function (error) {
                console.log(error);
            }
        });
    }

    //添加 RoleIdList
    $.ajax({
        type: "GET",
        url: "http://localhost:60440/Role/RoleIdList",
        dataType: "json",
        success: function (res) {
            //打印返回结果
            console.log(res);
            $("#roleid").html('');
            $("#roleid").append(' <option value="" disabled="" selected="" hidden="">选择角色</option>');
            $.each(res, function (index, data) {
                $("#roleid").append(`<option value="${data.id}">${data.rolename}</option>`)
            });
        },
        error: function (error) {
            console.log(error);
        }
    });  

    //[alert] 提示框
    function showTips(tips, height, time, color) {
        var windowWidth = document.documentElement.clientWidth;
        //当页面不存在时 创建
        if (!document.getElementById("tipsClass")) {
            var tipsDiv = '<div id="tipsClass"></div>';
            console.log("执行");
            $('body').append(tipsDiv);
        }
        $('div#tipsClass').css({
            'top': 0 + 'px',
            'left': (windowWidth / 2) - (tips.length * 13 / 2) + 'px',
            'position': 'absolute',
            'padding': '15px 25px',
            'background': color,//#8FBC8F
            'font-size': 12 + 'px',
            'margin': '0 auto',
            'text-align': 'center',
            'width': 'auto',
            'color': '#fff',
            'opacity': '0.8',
            'z-index': '9999',
            'border-radius': '4px',
            'box-shadow': '0 4px 12px rgba(0, 0, 0, .15)',
        }).text(tips).show().animate({ 'top': height }, 200);
        setTimeout(function () { $('div#tipsClass').fadeOut(); }, (time * 800));
    }
    userSearch(Index);


</script>
<!---Modal end -->
